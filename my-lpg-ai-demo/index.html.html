<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LPG Plant Maintenance AI Assistant (Demo)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'iocl-dark': '#003366',
            'iocl-orange': '#FF9933',
            'iocl-light': '#f0f8ff',
            'lpg-green': '#10b981'
          },
          fontFamily: { sans: ['Inter','sans-serif'] }
        }
      }
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{background-color:#f0f8ff;background-image:radial-gradient(#d3d3d3 1px,transparent 0);background-size:30px 30px;background-attachment:fixed}
    .pulse-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background-color:#10b981;box-shadow:0 0 0 rgba(16,185,129,0.4);animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,0.7)}70%{box-shadow:0 0 0 6px rgba(16,185,129,0)}100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}
  </style>
</head>
<body class="font-sans">

  <div id="loading-overlay" class="fixed inset-0 bg-iocl-dark bg-opacity-90 flex items-center justify-center z-50 hidden">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-iocl-orange"></div>
      <p class="text-white mt-4 text-lg font-semibold">Connecting to Global Database...</p>
    </div>
  </div>

  <div class="max-w-7xl mx-auto py-4 sm:py-8">
    <header class="text-center mb-8 bg-white p-6 rounded-xl shadow-xl border-b-4 border-iocl-orange">
      <div class="flex items-center justify-center mb-4">
        <!-- Your provided image: ensure indane_1.jpg is in the same folder as index.html -->
        <img src="indane_1.jpg" alt="Indane / IndianOil Logo" class="h-24 w-auto"
             onerror="this.onerror=null;this.src='https://placehold.co/200x60/003366/FFFFFF?text=IOCL';">
      </div>

      <div id="user-info" class="text-sm text-gray-600 mt-2 pt-2 border-t flex flex-col sm:flex-row justify-center items-center gap-2">
        <span>Welcome,</span>
        <input type="text" id="user-display-name" placeholder="Enter your Name/Designation"
               class="border border-gray-300 rounded px-2 py-1 text-iocl-dark font-semibold w-48 text-center" onchange="saveUserName(this.value)">
        <span class="text-xs text-gray-400">(ID: <span id="user-id-short">...</span>)</span>
        <span class="ml-2 text-lpg-green text-xs font-bold flex items-center"><span class="pulse-dot mr-1"></span> Live</span>
      </div>
    </header>

    <!-- Main grid simplified for demo -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1">
        <div class="bg-white p-6 rounded-xl shadow-lg border border-iocl-dark/20">
          <h2 class="text-2xl font-semibold mb-4">Post to Public Board</h2>

          <form id="question-form" onsubmit="handleNewQuestion(event)">
            <div class="mb-3 flex space-x-4">
              <label class="inline-flex items-center"><input type="radio" name="issueType" value="question" checked onchange="updateFormPlaceholder(this.value)"><span class="ml-2">Doubt (Question)</span></label>
              <label class="inline-flex items-center"><input type="radio" name="issueType" value="resolved" onchange="updateFormPlaceholder(this.value)"><span class="ml-2">Resolved Issue</span></label>
            </div>

            <div class="mb-3">
              <label for="issue-topic" class="block text-sm font-medium mb-1">Select Topic/Equipment:</label>
              <select id="issue-topic" required class="w-full p-3 border border-gray-300 rounded-lg bg-white text-sm"></select>
            </div>

            <textarea id="question-text" rows="5" placeholder="Describe the maintenance issue..."
                      class="w-full p-3 border border-gray-300 rounded-lg mb-3 resize-none"></textarea>

            <textarea id="solution-text" rows="3" placeholder="Describe the resolution"
                      class="w-full p-3 border border-gray-300 rounded-lg resize-none mb-3 hidden"></textarea>

            <button id="submit-btn" class="w-full bg-iocl-dark text-white py-3 rounded-lg font-semibold">Post & Sync to Cloud</button>
          </form>
        </div>

        <!-- Manual metadata upload card (unchanged) -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-iocl-dark/20 mt-6">
          <h2 class="text-2xl font-semibold mb-4">Upload Manual (Metadata)</h2>
          <form id="manual-form" onsubmit="handleNewManual(event)">
            <div class="mb-3">
              <label for="manualFile" class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 p-2">
                <svg class="w-6 h-6 text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v16a1 1 0 01-1 1H8a1 1 0 01-1-1v-8zM12 11v6m-3-3h6"></path></svg>
                <p id="fileText" class="text-sm text-gray-500">Click to select a PDF</p>
                <p class="text-xs text-gray-400">PDF only</p>
                <input id="manualFile" type="file" accept="application/pdf" class="hidden" onchange="window.handleFileSelection(event)">
              </label>
            </div>

            <input type="text" id="equipment-tag" placeholder="Equipment Tag (e.g., K-101)" class="w-full p-3 border border-gray-300 rounded-lg mb-3">
            <p class="text-xs text-red-500 mb-3">⚠ Only file metadata is saved — the actual PDF is NOT uploaded in this demo.</p>
            <button id="manual-submit-btn" type="submit" disabled class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold">Submit Manual Metadata</button>
          </form>

          <div class="mt-6">
            <h3 class="text-xl font-semibold mb-3">Recently Added Manuals</h3>
            <div id="manuals-list-mini" class="space-y-2 text-sm max-h-40 overflow-y-auto p-2 bg-gray-50 rounded-lg">
              <p class="text-gray-500 italic">Loading manuals...</p>
            </div>
          </div>
        </div>
      </div>

      <div class="lg:col-span-2">
        <div class="bg-white p-6 rounded-xl shadow-lg border border-iocl-dark/20">
          <h2 class="text-2xl font-semibold mb-4 flex justify-between items-center">
            <span>Public Knowledge Feed <span class="text-xs bg-lpg-green text-white px-2 py-1 rounded-full animate-pulse">Live</span></span>
            <div class="flex items-center space-x-2">
              <label class="text-sm">Filter:</label>
              <select id="topic-filter" onchange="setFilterTopic(this.value)" class="p-2 border border-gray-300 rounded-lg text-sm bg-white w-48"></select>
            </div>
          </h2>

          <div id="issues-list" class="space-y-4 h-96 overflow-y-scroll pr-2">
            <p class="text-gray-500 text-center mt-10">Syncing with public database...</p>
          </div>
        </div>

        <!-- AI Panel -->
        <div id="ai-panel" class="mt-8 bg-white p-6 rounded-xl shadow-2xl border-2 border-iocl-orange/50" style="display:none;">
          <div class="flex items-center mb-4">
            <img src="indane_1.jpg" class="h-10 w-10 object-cover rounded-full mr-3 border-2 border-iocl-orange p-1" onerror="this.onerror=null;this.src='https://placehold.co/40x40/003366/FFFFFF?text=AI';">
            <h2 class="text-2xl font-bold text-iocl-orange" id="ai-panel-title">AI Co-Pilot Suggestion</h2>
          </div>

          <div id="officer-replies-section" class="mb-6 hidden">
            <h3 class="text-xl font-semibold mb-2">Answers from Fellow Officers</h3>
            <div id="replies-container" class="space-y-3 p-3 bg-gray-50 rounded-lg max-h-48 overflow-y-auto">
              <p class="text-gray-500 text-sm italic">No officer replies yet. Be the first!</p>
            </div>

            <form id="reply-form" onsubmit="handleNewReply(event)">
              <input type="hidden" id="reply-issue-id">
              <textarea id="reply-text" rows="2" placeholder="Post your answer..." class="w-full p-2 border border-gray-300 rounded-lg resize-none"></textarea>
              <button id="reply-btn" class="mt-2 bg-lpg-green text-white py-1.5 px-4 rounded-lg text-sm">Submit Answer</button>
            </form>
          </div>

          <div id="ai-suggestion-section" class="pt-4 border-t">
            <h3 class="text-xl font-semibold mb-2">AI Analysis and Solution Prompt</h3>
            <p id="ai-loading" class="text-iocl-dark font-medium hidden">Analyzing question and searching resources...</p>
            <div id="ai-results" class="space-y-6 text-gray-700"></div>
            <div id="ai-sources" class="mt-4 pt-4 border-t text-sm" style="display:none;">
              <h4 class="font-semibold">Grounded Sources:</h4>
              <ul id="source-list" class="list-disc pl-5 mt-1 space-y-1"></ul>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Firebase + App logic (trimmed for brevity; keep your existing Firestore logic) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // -------------------------
    // CONFIG (demo friendly)
    // -------------------------
    // Do NOT put your API key here. Instead put it into Netlify env var GEMINI_API_KEY.
    const EXTERNAL_FIREBASE_CONFIG = null; // -> if hosting externally, set your firebase config object before deploying
    const EXTERNAL_GEMINI_API_KEY = null; // intentionally null: we call the proxy hosted on Netlify

    // App state
    let app, db, auth, userId = null;
    let issueCache = {}, currentIssueId = null;
    let currentReplyListener = null;
    let currentFilterTopic = 'All Topics';

    // Topics list (same as before)
    const TOPICS = ["KOSAN CAROUSEL","HTPC CAROUSEL","OTHER CAROUSEL","LPG PUMP","LPG COMPRESSOR","FIRE ENGINE & PUMP","DG SET","AIR COMPRESSOR","AIR DRYER","TRANSFORMER","VCB","ACB","PMCC PANELS","TLD","MSV","AGB","HORTON SPHERE","OTHER EQUIPMENT"];

    // Utility functions
    function formatBytes(bytes, decimals = 2){ if(bytes===0) return '0 Bytes'; const k=1024,dm=decimals<0?0:decimals, sizes=['Bytes','KB','MB','GB','TB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return parseFloat((bytes/Math.pow(k,i)).toFixed(dm))+' '+sizes[i]; }
    function alertUser(message, targetFormId, className='bg-red-100 border border-red-400 text-red-700'){ const targetForm=document.getElementById(targetFormId); if(!targetForm) return; let existing=targetForm.querySelector('.custom-alert'); if(existing) existing.remove(); const div=document.createElement('div'); div.className=`${className} px-4 py-2 rounded mb-4 custom-alert`; div.textContent=message; targetForm.insertBefore(div, targetForm.firstChild); setTimeout(()=>div.remove(),5000); }

    // Populate topics
    function populateTopicSelectors(){
      const issueTopicSelect=document.getElementById('issue-topic');
      const topicFilterSelect=document.getElementById('topic-filter');
      issueTopicSelect.innerHTML=''; topicFilterSelect.innerHTML=`<option value="All Topics">All Topics</option>`;
      TOPICS.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; issueTopicSelect.appendChild(o); const f=document.createElement('option'); f.value=t; f.textContent=t; topicFilterSelect.appendChild(f); });
    }
    populateTopicSelectors();

    // Save/display name
    function loadSavedUserName(){ const s = localStorage.getItem('lpg_platform_username'); if(s) document.getElementById('user-display-name').value = s; }
    window.saveUserName = function(name){ if(name && name.trim()) localStorage.setItem('lpg_platform_username', name.trim()); }
    loadSavedUserName();

    // Initialize firebase (if you set EXTERNAL_FIREBASE_CONFIG before deploy)
    async function initFirebase(){
      try {
        if(!EXTERNAL_FIREBASE_CONFIG || Object.keys(EXTERNAL_FIREBASE_CONFIG).length===0){
          console.warn("Firebase config missing - Firestore features will be disabled until you set the config.");
          return;
        }
        app = initializeApp(EXTERNAL_FIREBASE_CONFIG);
        db = getFirestore(app);
        auth = getAuth(app);
        await signInAnonymously(auth);
        onAuthStateChanged(auth, user=>{
          if(user){ userId = user.uid; document.getElementById('user-id-short').textContent = userId.substring(0,6); setupIssueListener(); setupManualsListener(); }
        });
      } catch(e){ console.error("Firebase init error", e); }
    }
    // Call initFirebase() only if you set EXTERNAL_FIREBASE_CONFIG before deploying. For demo you can leave it null.

    // ----------- AI: analyzeQuestion() (calls Netlify proxy) -------------
    // IMPORTANT: this function calls your Netlify serverless function at /.netlify/functions/gemini-proxy
    async function analyzeQuestion(prompt){
      const systemPrompt = "You are the IOCL LPG Plant Maintenance Co-Pilot, an expert in industrial process equipment (Pumps, Compressors, Carousels, Spheres, Electrical, Instrumentation). Provide a concise, highly technical analysis of the reported fault. Suggest probable causes, necessary checks, and immediate mitigation steps. Format as short paragraphs and bullet lists suitable for a field officer.";
      const resp = await fetch('/.netlify/functions/gemini-proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, systemInstruction: systemPrompt })
      });
      if(!resp.ok){
        const txt = await resp.text();
        console.error('AI proxy error', resp.status, txt);
        throw new Error('AI proxy error');
      }
      const json = await resp.json();
      const candidate = json?.candidates?.[0] || json?.data?.candidates?.[0] || null;
      // Adapt to either direct function response or .data wrapper (some proxies return the raw API response)
      const finalCandidate = candidate || (json.data && json.data.candidates && json.data.candidates[0]) || null;
      const text = finalCandidate?.content?.parts?.[0]?.text || (json?.text) || 'No AI response.';
      // extract sources if provided
      const grounding = finalCandidate?.groundingMetadata?.groundingAttributions || [];
      const sources = grounding.map(a => ({ uri: a.web?.uri, title: a.web?.title })).filter(s=>s.uri && s.title);
      return { text, sources };
    }

    // Placeholder: minimal UI handlers to avoid runtime errors (keep your original implementations)
    function updateFormPlaceholder(type){
      const q = document.getElementById('question-text');
      const s = document.getElementById('solution-text');
      const btn = document.getElementById('submit-btn');
      if(type==='resolved'){ q.placeholder='Summarize the problem'; s.classList.remove('hidden'); btn.textContent='Post Resolved Solution'; }
      else { q.placeholder='Describe the maintenance issue'; s.classList.add('hidden'); btn.textContent='Post & Get AI Analysis'; }
    }
    window.updateFormPlaceholder = updateFormPlaceholder;

    // Note: For demo, many original Firestore functions like setupIssueListener, handleNewQuestion, handleNewManual, etc. are omitted here to keep the example concise.
    // In production or full demo, copy back your full JS logic for Firestore reads/writes and replies. The key change is analyzeQuestion() uses the Netlify proxy.

    // You can still call analyzeQuestion(prompt) in your handler for 'question' issues.
    // Example quick test button (uncomment to test):
    // analyzeQuestion("Compressor C-101 high vibration at startup, oil pressure fluctuating").then(r=>console.log(r)).catch(e=>console.error(e));

  </script>
</body>
</html>
